<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Soka Shuttle Live</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <script src='https://api.mapbox.com/mapbox-gl-js/v2.14.1/mapbox-gl.js'></script>
    <link href='https://api.mapbox.com/mapbox-gl-js/v2.14.1/mapbox-gl.css' rel='stylesheet' />
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; }
        #map { position: absolute; top: 0; bottom: 0; width: 100%; }
        
        .info-panel {
            position: absolute;
            top: 20px;
            left: 20px;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            padding: 20px;
            border-radius: 16px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.15);
            max-width: 320px;
            z-index: 10;
        }
        
        .info-panel h2 {
            color: #003366;
            font-size: 18px;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .status-dot {
            width: 8px;
            height: 8px;
            background: #10b981;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        .shuttle-info {
            background: linear-gradient(135deg, #003366 0%, #004080 100%);
            color: white;
            padding: 16px;
            border-radius: 12px;
            margin: 12px 0;
        }
        
        .shuttle-info h3 {
            font-size: 14px;
            opacity: 0.9;
            margin-bottom: 8px;
        }
        
        .eta-time {
            font-size: 32px;
            font-weight: 700;
            margin-bottom: 4px;
        }
        
        .eta-label {
            font-size: 13px;
            opacity: 0.8;
        }
        
        .stop-info {
            margin: 12px 0;
            padding: 12px;
            background: #f8fafc;
            border-radius: 8px;
        }
        
        .stop-info strong {
            color: #003366;
            font-size: 14px;
        }
        
        .stop-info p {
            color: #64748b;
            font-size: 13px;
            margin-top: 4px;
        }
        
        .btn {
            background: #003366;
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 8px;
            width: 100%;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .btn:hover {
            background: #004080;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0,51,102,0.3);
        }
        
        .btn:active {
            transform: translateY(0);
        }
        
        .schedule {
            margin-top: 12px;
            padding-top: 12px;
            border-top: 1px solid #e2e8f0;
        }
        
        .schedule-item {
            display: flex;
            justify-content: space-between;
            padding: 6px 0;
            font-size: 13px;
            color: #64748b;
        }
        
        .schedule-item.next {
            color: #003366;
            font-weight: 600;
        }

        @media (max-width: 640px) {
            .info-panel {
                left: 10px;
                right: 10px;
                max-width: none;
                top: auto;
                bottom: 10px;
            }
        }
    </style>
</head>
<body>

<div id="map"></div>

<div class="info-panel">
    <h2>
        <span class="status-dot"></span>
        Shuttle Tracker
    </h2>
    
    <div class="shuttle-info">
        <h3>Next Arrival</h3>
        <div class="eta-time" id="eta-time">--</div>
        <div class="eta-label" id="eta-label">Calculating...</div>
    </div>
    
    <div class="stop-info">
        <strong id="stop-name">Select your location</strong>
        <p id="stop-distance">Tap below to find nearest stop</p>
    </div>
    
    <button class="btn" onclick="locateUser()">üìç Find My Location</button>
    
    <div class="schedule">
        <div class="schedule-item next" id="next-shuttle">Next: --</div>
        <div class="schedule-item" id="following-shuttle">Following: --</div>
    </div>
</div>

<script>
    mapboxgl.accessToken = 'pk.eyJ1IjoicGVlYm9hdCIsImEiOiJjbWtyM3JnZm8wbDZsM2Rwemh2bXVwZnE5In0.ZneKju4nnhfYcJOg3TKRDA';
    
    const map = new mapboxgl.Map({
        container: 'map',
        style: 'mapbox://styles/mapbox/streets-v12',
        center: [-117.735, 33.5554],
        zoom: 14
    });

   
// Corrected Shuttle Loop coordinates
const routeCoordinates = [
    // 1. START: Ikeda Library
    [-117.7356, 33.5554], 
    [-117.7348, 33.5575], // Following University Dr North
    [-117.7325, 33.5610], // Turning right toward campus exit
    [-117.7330, 33.5650], // Wood Canyon Dr North
    [-117.7315, 33.5710], // Aliso Creek Rd North
    // 2. STOP: Town Center
    [-117.7250, 33.5743], 
    [-117.7265, 33.5775], // Aliso Creek Rd North curve
    // 3. STOP: The Commons
    [-117.7241, 33.5784], 
    [-117.7215, 33.5770], // Heading toward Pacific Park Dr
    [-117.7180, 33.5680], // Pacific Park Dr Southbound
    [-117.7145, 33.5665], // Alicia Pkwy Southbound
    // 4. STOP: Walmart
    [-117.7135, 33.5638], 
    [-117.7160, 33.5570], // Alicia Pkwy Westbound
    [-117.7220, 33.5535], // Wood Canyon Dr Westbound
    [-117.7280, 33.5520], // Curve toward Soka entrance
    [-117.7315, 33.5515], // Turning into Soka
    [-117.7340, 33.5535], // University Dr uphill
    // 5. RETURN: Ikeda Library
    [-117.7356, 33.5554] 
];

const stops = [
    { name: "Ikeda Library", coords: [-117.7356, 33.5554], id: 1 },
    { name: "Town Center", coords: [-117.7250, 33.5743], id: 2 },
    { name: "The Commons", coords: [-117.7241, 33.5784], id: 3 },
    { name: "Walmart", coords: [-117.7135, 33.5638], id: 4 }
];
    // Shuttle schedule (every 15 minutes starting at 7 AM)
    const scheduleStart = 7 * 60; // 7 AM in minutes
    const scheduleEnd = 22 * 60;  // 10 PM in minutes
    const interval = 15; // minutes

    let shuttlePosition = 0; // 0 to 1 along route
    let shuttleMarker;
    let userMarker;

    map.on('load', () => {
        // Add route line
        map.addSource('route', {
            type: 'geojson',
            data: {
                type: 'Feature',
                geometry: {
                    type: 'LineString',
                    coordinates: routeCoordinates
                }
            }
        });
        
        map.addLayer({
            id: 'route-line',
            type: 'line',
            source: 'route',
            layout: { 'line-join': 'round', 'line-cap': 'round' },
            paint: { 
                'line-color': '#003366', 
                'line-width': 4,
                'line-opacity': 0.6
            }
        });

        // Add stops
        stops.forEach(stop => {
            const el = document.createElement('div');
            el.style.width = '16px';
            el.style.height = '16px';
            el.style.background = '#fff';
            el.style.border = '3px solid #003366';
            el.style.borderRadius = '50%';
            el.style.cursor = 'pointer';
            
            new mapboxgl.Marker(el)
                .setLngLat(stop.coords)
                .setPopup(new mapboxgl.Popup().setHTML(`<strong>${stop.name}</strong>`))
                .addTo(map);
        });

        // Create shuttle marker
        const shuttleEl = document.createElement('div');
        shuttleEl.innerHTML = 'üöê';
        shuttleEl.style.fontSize = '32px';
        shuttleEl.style.cursor = 'pointer';
        
        shuttleMarker = new mapboxgl.Marker(shuttleEl)
            .setLngLat(routeCoordinates[0])
            .addTo(map);

        // Start shuttle animation
        animateShuttle();
        updateETAs();
        setInterval(updateETAs, 10000); // Update every 10 seconds
    });

    function animateShuttle() {
        // Move shuttle along route (completes loop every 20 minutes)
        const speed = 1 / (20 * 60 * 60); // position per frame at 60fps
        
        setInterval(() => {
            shuttlePosition = (shuttlePosition + speed) % 1;
            
            // Calculate position along route
            const totalSegments = routeCoordinates.length - 1;
            const segment = shuttlePosition * totalSegments;
            const segmentIndex = Math.floor(segment);
            const segmentProgress = segment - segmentIndex;
            
            const start = routeCoordinates[segmentIndex];
            const end = routeCoordinates[(segmentIndex + 1) % routeCoordinates.length];
            
            const lng = start[0] + (end[0] - start[0]) * segmentProgress;
            const lat = start[1] + (end[1] - start[1]) * segmentProgress;
            
            shuttleMarker.setLngLat([lng, lat]);
        }, 1000 / 60);
    }

    function updateETAs() {
        const now = new Date();
        const currentMinutes = now.getHours() * 60 + now.getMinutes();
        
        // Find next scheduled times
        const nextTimes = [];
        for (let t = scheduleStart; t <= scheduleEnd; t += interval) {
            if (t > currentMinutes) {
                nextTimes.push(t);
                if (nextTimes.length === 2) break;
            }
        }
        
        if (nextTimes.length === 0) {
            document.getElementById('eta-time').textContent = 'Service Ended';
            document.getElementById('eta-label').textContent = 'Returns tomorrow at 7:00 AM';
            return;
        }
        
        const nextTime = nextTimes[0];
        const minutesUntil = nextTime - currentMinutes;
        
        document.getElementById('eta-time').textContent = `${minutesUntil} min`;
        document.getElementById('eta-label').textContent = `Arrives at ${formatTime(nextTime)}`;
        
        // Update schedule display
        document.getElementById('next-shuttle').textContent = `Next: ${formatTime(nextTime)}`;
        if (nextTimes.length > 1) {
            document.getElementById('following-shuttle').textContent = `Following: ${formatTime(nextTimes[1])}`;
        }
    }

    function formatTime(minutes) {
        const hours = Math.floor(minutes / 60);
        const mins = minutes % 60;
        const period = hours >= 12 ? 'PM' : 'AM';
        const displayHours = hours > 12 ? hours - 12 : (hours === 0 ? 12 : hours);
        return `${displayHours}:${mins.toString().padStart(2, '0')} ${period}`;
    }

    function locateUser() {
        if (!navigator.geolocation) {
            alert('Geolocation not supported by your browser');
            return;
        }

        navigator.geolocation.getCurrentPosition((pos) => {
            const { latitude, longitude } = pos.coords;

            if (userMarker) userMarker.remove();

            const el = document.createElement('div');
            el.style.width = '20px';
            el.style.height = '20px';
            el.style.background = '#3b82f6';
            el.style.border = '4px solid white';
            el.style.borderRadius = '50%';
            el.style.boxShadow = '0 0 0 4px rgba(59, 130, 246, 0.3)';

            userMarker = new mapboxgl.Marker(el)
                .setLngLat([longitude, latitude])
                .addTo(map);

            map.flyTo({ center: [longitude, latitude], zoom: 16 });

            findClosestStop(longitude, latitude);
        }, (error) => {
            alert('Unable to get your location. Please enable location services.');
        });
    }

    function findClosestStop(userLng, userLat) {
        let closest = null;
        let minDist = Infinity;

        stops.forEach(stop => {
            const [lng, lat] = stop.coords;
            const dist = Math.sqrt(
                Math.pow((lng - userLng) * Math.cos(userLat * Math.PI / 180), 2) +
                Math.pow(lat - userLat, 2)
            );

            if (dist < minDist) {
                minDist = dist;
                closest = stop;
            }
        });

        if (closest) {
    const distanceMeters = minDist * 111139; // degrees ‚Üí meters
    const distanceMiles = distanceMeters / 1609.34;

    const distanceText =
        distanceMiles < 0.1
            ? `${Math.round(distanceMiles * 5280)} ft away`
            : `${distanceMiles.toFixed(2)} miles away`;

    document.getElementById('stop-name').textContent = closest.name;
    document.getElementById('stop-distance').textContent = distanceText;
}
    }
</script>
